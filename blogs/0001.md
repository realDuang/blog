---
title: 大型前端项目 DevOps 沉思录 —— CD 篇
categories: 架构设计
tags: 设计模式
date: 2021-06-25 18:26:27
---

:::tip
`DevOps`一词源于`Development` 和 `Operations` 的组合，即将软件交付过程中开发与测试运维的环节通过工具链打通，并通过自动化的测试与监控，减少团队的时间损耗，更加高效稳定地交付制品。

本篇文章将着重探讨 `DevOps` 在 `持续部署阶段` 需要提供的能力，介绍大型项目应该如何稳定并高频率的迭代项目版本。
:::

<!-- more -->

在系列的[上一篇文章](https://www.zakum.cn/blogs/2021-05-11.html)中，我们详细介绍了腾讯文档前端在 `DevOps` 的 `持续集成阶段` 所作出的实践与思考，介绍了在CI阶段项目工作流的设计及流水线的优化思路。

本次我们将探讨 `DevOps` 在 `持续部署阶段` 需要提供的能力，介绍大型项目应该如何稳定并高频率的迭代项目版本。

## 正确认识持续部署

我们在为一个项目搭建自动化流水线时，通常会将项目的代码检查、自动化测试、代码编译、部署环境等等环节全部放入同一条流水线，因为许多时候，这都是一条逻辑清晰且稳定的链路，能够确保发布产物一定完成了全部的自动化检查。

常见的项目流水线应该如下图所示，是一条大而全的串行链路：

![ci&cd pre](https://zakum-1252497671.cos.ap-guangzhou.myqcloud.com/ci&cd pre.png)

由于这样的CI/CD流水线经常被各类文章列为最佳实践，于是很多时候，我们很容易将CI/CD流程混为一谈，甚至将其等同于构建 `DevOps` 流水线的全流程，这种认知其实是不对的。

> 持续部署（Continuous deployment，缩写为CD），是一种软件工程方法，意指在软件开发流程中，以自动化方式，频繁而且持续性的，将软件部署到生产环境中，使软件产品能够快速的发展。

与上一章介绍的`持续集成`不同，`持续部署`更多的是侧重在已经生成的制品如何**高频**且**稳定**的自动部署到各种测试、灰度与生产环境的。想要做到高频与稳定，我们需要彻底将`持续部署`环节从`持续集成`环节中分离出来，形成独立的流水线。

## 解耦CI与CD环节

### 为何要将CD从CI中分离

一个项目在发展成熟的过程中，代码将逐渐变得庞大且复杂，项目编译、代码检查和自动化测试的时间将不可避免的越变越长。但与此同时，高频部署与版本切换对于一个自动化成熟的项目来说也是一个必选项。尽管在`持续集成`阶段，我们可以用上篇文章介绍过的次级构建等方法来减少从代码推送到制品生成之间的耗时，但距离我们期望的快速版本切换来说仍然杯水车薪。

这个问题在现网出现致命故障回滚时暴露的尤为明显。以我们团队项目之前的实践为例，在回滚版本时，实质上是将打过`git tag`的上一版本节点抽离出分支进行一次提交，等待其执行了完整的CI/CD流程后在源站服务器上更新我们的HTML完成更新。也就是说，我们的回滚操作所需的准备时间几乎是和发布一个新版本同样长。这对于一个用户量较大的成熟项目来说是不可接受的。

其实，我们是被长时间的自动化构建思维带入了误区，认为发布流程不经过CI验证过就不是一个合格的产物。想要实现瞬间回滚其实很简单，我们只需要记录之前版本的发布产物，在需要回滚时直接进入服务器将之前记录过的某一版本文件强行发布到源站服务器即可。

但是这种由人工来手动选择文件并拷贝覆盖到服务器的方式显然容易出错，我们还是应该利用流水线的能力来实现这一功能，而这就是与 `持续集成` 分离后，`持续部署` 流水线的其中一个能力。

`DevOps`中所谓**持续**，是指每完成一个完整的部分，就向下个环节推进，如果发现问题可以在当前环节内调整和重试，并不会影响其他环节。以回滚为例，同一个制品已经通过了`持续集成`的测试并完成交付后，就不应该再对其进行第二次CI环节了，而只需重新执行`持续部署`流程即可，而通常，`持续部署`的环境切换效率是极高的，这就是将CI与CD环节解耦的意义。

### 如何分离

上一章说过，CI的终点是将产物整理打包生成docker制品，存入镜像仓库（对于制品的存放形式是docker镜像还是普通文件夹可以参看上一章节，按需选择）。上面的例子中提到，我们需要记录下每一个通过CI环节的产物




大型项目的版本回退通常不只有前端这一个html，还会涉及到许多后端微服务的版本切换







<!-- ## 结语

## 参考资料

1. 《持续交付 2.0》—— 乔梁 著 -->
