<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.9">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="alternate" type="application/atom+xml" href="https://blog.realduang.com/atom.xml" title="枫之谷 Atom Feed"><link rel="alternate" type="application/json" href="https://blog.realduang.com/feed.json" title="枫之谷 JSON Feed"><link rel="alternate" type="application/rss+xml" href="https://blog.realduang.com/rss.xml" title="枫之谷 RSS Feed"><title>NodeJS 服务 Docker 镜像极致优化指北 | 枫之谷</title><meta name="description" content="这个人很懒，但还是想留下些什么东西。">
    <link rel="preload" href="/assets/style-BtB9LtaP.css" as="style"><link rel="stylesheet" href="/assets/style-BtB9LtaP.css">
    <link rel="modulepreload" href="/assets/app-DG1e-Jaf.js"><link rel="modulepreload" href="/assets/2021-07-25.html-CZXpggDd.js">
    <link rel="prefetch" href="/assets/timeline.html-DazkSpUV.js" as="script"><link rel="prefetch" href="/assets/posts.html-DCmO_9hF.js" as="script"><link rel="prefetch" href="/assets/friendship-link.html-CFLFS73P.js" as="script"><link rel="prefetch" href="/assets/1.html-Bcr8HTqH.js" as="script"><link rel="prefetch" href="/assets/1.html-BKwlQgQl.js" as="script"><link rel="prefetch" href="/assets/2.html-BmXXfNCQ.js" as="script"><link rel="prefetch" href="/assets/1.html-BXctWHHM.js" as="script"><link rel="prefetch" href="/assets/1.html-DQnl75Lq.js" as="script"><link rel="prefetch" href="/assets/1.html-Clv-y0jf.js" as="script"><link rel="prefetch" href="/assets/1.html-D9ks30Hd.js" as="script"><link rel="prefetch" href="/assets/1.html-DqhAJZLH.js" as="script"><link rel="prefetch" href="/assets/1.html-DGO6EKg2.js" as="script"><link rel="prefetch" href="/assets/1.html-5h2ZuVL7.js" as="script"><link rel="prefetch" href="/assets/2.html-CoBVxyxs.js" as="script"><link rel="prefetch" href="/assets/1.html-Dl9H2EeH.js" as="script"><link rel="prefetch" href="/assets/1.html-DagLkH4R.js" as="script"><link rel="prefetch" href="/assets/1.html-DOdkZ8ik.js" as="script"><link rel="prefetch" href="/assets/1.html-rsGOuS3z.js" as="script"><link rel="prefetch" href="/assets/1.html-CwDOv9Yf.js" as="script"><link rel="prefetch" href="/assets/1.html-BH-ZTiHp.js" as="script"><link rel="prefetch" href="/assets/1.html-BBGLXKCR.js" as="script"><link rel="prefetch" href="/assets/1.html-D55UYu7g.js" as="script"><link rel="prefetch" href="/assets/1.html-DeqJaaqs.js" as="script"><link rel="prefetch" href="/assets/1.html-DS5Elhy1.js" as="script"><link rel="prefetch" href="/assets/1.html-BqbFxoiV.js" as="script"><link rel="prefetch" href="/assets/1.html-B-1jKCBf.js" as="script"><link rel="prefetch" href="/assets/1.html-BDACFKMb.js" as="script"><link rel="prefetch" href="/assets/1.html-Ci_2Hef1.js" as="script"><link rel="prefetch" href="/assets/1.html-c6KuTX_o.js" as="script"><link rel="prefetch" href="/assets/1.html-CDqd2sAV.js" as="script"><link rel="prefetch" href="/assets/1.html-DVPahGgU.js" as="script"><link rel="prefetch" href="/assets/1.html-BsJsYqPQ.js" as="script"><link rel="prefetch" href="/assets/1.html-CRGMltwt.js" as="script"><link rel="prefetch" href="/assets/1.html-zZP5fnKf.js" as="script"><link rel="prefetch" href="/assets/1.html-BnqN8hIz.js" as="script"><link rel="prefetch" href="/assets/1.html-BR1BtjVf.js" as="script"><link rel="prefetch" href="/assets/1.html-DfbaFI_h.js" as="script"><link rel="prefetch" href="/assets/1.html-DzHMblG3.js" as="script"><link rel="prefetch" href="/assets/1.html-1j4Im-Fg.js" as="script"><link rel="prefetch" href="/assets/1.html-CbRtZl_0.js" as="script"><link rel="prefetch" href="/assets/1.html-B9uMEjM8.js" as="script"><link rel="prefetch" href="/assets/1.html-7nPvVkSe.js" as="script"><link rel="prefetch" href="/assets/1.html-CDnOF8M2.js" as="script"><link rel="prefetch" href="/assets/1.html-D3pjwSvI.js" as="script"><link rel="prefetch" href="/assets/1.html-Cza3zjV8.js" as="script"><link rel="prefetch" href="/assets/1.html-GjC6Fy90.js" as="script"><link rel="prefetch" href="/assets/1.html-CTGmTDvf.js" as="script"><link rel="prefetch" href="/assets/1.html-C3NJPO9w.js" as="script"><link rel="prefetch" href="/assets/1.html-BZ9em-Yo.js" as="script"><link rel="prefetch" href="/assets/1.html-BgUTjYoN.js" as="script"><link rel="prefetch" href="/assets/1.html-6wvmVmbJ.js" as="script"><link rel="prefetch" href="/assets/1.html-DNt63HrP.js" as="script"><link rel="prefetch" href="/assets/2.html-MFr5NJq_.js" as="script"><link rel="prefetch" href="/assets/3.html-BJzlitpC.js" as="script"><link rel="prefetch" href="/assets/4.html-DUjgf6pl.js" as="script"><link rel="prefetch" href="/assets/5.html-C2UGWz_K.js" as="script"><link rel="prefetch" href="/assets/index.html-DmREwR5W.js" as="script"><link rel="prefetch" href="/assets/2021-05-07.html-BlxW4dq-.js" as="script"><link rel="prefetch" href="/assets/2016-10-16.html-C4R3ycIA.js" as="script"><link rel="prefetch" href="/assets/2019-09-20.html-CJA16n6k.js" as="script"><link rel="prefetch" href="/assets/2019-09-23.html-DIzOWkr7.js" as="script"><link rel="prefetch" href="/assets/2019-09-26.html-4eP8Rjgj.js" as="script"><link rel="prefetch" href="/assets/2019-10-07.html-2waQit4p.js" as="script"><link rel="prefetch" href="/assets/2022-09-08.html-BG7MsJ-v.js" as="script"><link rel="prefetch" href="/assets/ 2017-11-30.html-B-8nnmjC.js" as="script"><link rel="prefetch" href="/assets/2017-02-10.html-CmZsUFEr.js" as="script"><link rel="prefetch" href="/assets/2017-02-20.html-MNBCiboS.js" as="script"><link rel="prefetch" href="/assets/2017-04-16.html-CJHswkEt.js" as="script"><link rel="prefetch" href="/assets/2017-05-25.html-0MfTVaUh.js" as="script"><link rel="prefetch" href="/assets/2017-12-01.html-CQ05daoF.js" as="script"><link rel="prefetch" href="/assets/2017-12-03.html-BN3gu6cV.js" as="script"><link rel="prefetch" href="/assets/2017-12-04.html-e8fdSm9f.js" as="script"><link rel="prefetch" href="/assets/2018-03-14.html-D1Lvzcz-.js" as="script"><link rel="prefetch" href="/assets/2018-11-12.html-B7Wf3Og4.js" as="script"><link rel="prefetch" href="/assets/2019-12-21.html-DOAKwi_Y.js" as="script"><link rel="prefetch" href="/assets/2020-01-21.html-Bbe7hnKK.js" as="script"><link rel="prefetch" href="/assets/2024-12-02.html-BaI-0mvF.js" as="script"><link rel="prefetch" href="/assets/2017-09-17.html-2nrKq7mL.js" as="script"><link rel="prefetch" href="/assets/2020-06-16.html-DqibX37G.js" as="script"><link rel="prefetch" href="/assets/2020-07-13.html-DEHffBW5.js" as="script"><link rel="prefetch" href="/assets/2020-11-02.html-7iGN9pQu.js" as="script"><link rel="prefetch" href="/assets/2021-05-11.html-BOObFpQy.js" as="script"><link rel="prefetch" href="/assets/2022-01-25.html-BzmpTMah.js" as="script"><link rel="prefetch" href="/assets/2022-03-15.html-CaqXD-kQ.js" as="script"><link rel="prefetch" href="/assets/2023-08-21.html-DO3vk2pq.js" as="script"><link rel="prefetch" href="/assets/2024-05-07.html-B3CxSJj5.js" as="script"><link rel="prefetch" href="/assets/2017-01-05.html-heYg-yeT.js" as="script"><link rel="prefetch" href="/assets/2017-05-12.html-D5htQ0sQ.js" as="script"><link rel="prefetch" href="/assets/2017-06-11.html-D4mv_phQ.js" as="script"><link rel="prefetch" href="/assets/2017-07-02.html-BPEKKA2R.js" as="script"><link rel="prefetch" href="/assets/2018-01-03.html-BlR7HsgE.js" as="script"><link rel="prefetch" href="/assets/2021-02-01.html-3y2ktcU-.js" as="script"><link rel="prefetch" href="/assets/2021-03-13.html-CzNNQC5d.js" as="script"><link rel="prefetch" href="/assets/black-myth-ue5-reverse-engineering.html-C8YhJE-H.js" as="script"><link rel="prefetch" href="/assets/0.introductory.html-Ddsy2GZ3.js" as="script"><link rel="prefetch" href="/assets/1.inter-process-communication.html-BlfoW1xS.js" as="script"><link rel="prefetch" href="/assets/2.server-module-design.html-U-FxLToF.js" as="script"><link rel="prefetch" href="/assets/3.dependency-injection-design.html-Lkdx3Vj0.js" as="script"><link rel="prefetch" href="/assets/4.extension-loading-mechanism.html-D75uNvhY.js" as="script"><link rel="prefetch" href="/assets/5.vscode-server-design.html-DZfkSQ5B.js" as="script"><link rel="prefetch" href="/assets/di-framework-life-cycle.html-drGZaB2_.js" as="script"><link rel="prefetch" href="/assets/implementing-jupyter-debug-adapter-in-vscode.html-CExVRseZ.js" as="script"><link rel="prefetch" href="/assets/multi-instance-service-management-in-di-framework.html-C_LNoh2y.js" as="script"><link rel="prefetch" href="/assets/index.html-BEmWGBFW.js" as="script"><link rel="prefetch" href="/assets/index.html-BRMI8rys.js" as="script"><link rel="prefetch" href="/assets/404.html-B6ynnTeb.js" as="script"><link rel="prefetch" href="/assets/reco-valine-BI2JzRng.js" as="script"><link rel="prefetch" href="/assets/giscus-aTimukGI-CKTvSCx2.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><div class="common-wrapper series--no show-catalog"><header class="navbar-container" style="top:0;"><div class="site-brand nav-item"><img class="logo" src="/avatar.jpg" alt="枫之谷"><a href="/" class="site-name can-hide">枫之谷</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M16.612 2.214a1.01 1.01 0 0 0-1.242 0L1 13.419l1.243 1.572L4 13.621V26a2.004 2.004 0 0 0 2 2h20a2.004 2.004 0 0 0 2-2V13.63L29.757 15L31 13.428zM18 26h-4v-8h4zm2 0v-8a2.002 2.002 0 0 0-2-2h-4a2.002 2.002 0 0 0-2 2v8H6V12.062l10-7.79l10 7.8V26z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/timeline.html" class="link" aria-label="时间轴"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M23.586 13L21 10.414V6h2v3.586l2 2L23.586 13z" fill="currentColor"></path><path d="M22 18a8 8 0 1 1 8-8a8.01 8.01 0 0 1-8 8zm0-14a6 6 0 1 0 6 6a6.007 6.007 0 0 0-6-6z" fill="currentColor"></path><path d="M8.63 18l7 6H30v-2H16.37l-7-6H4V2H2v26a2.002 2.002 0 0 0 2 2h26v-2H4V18z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->时间轴<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a class="link" href="https://blog.realduang.com/feed.json" target="_blank" rel="noopener noreferrer" aria-label="订阅"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M8 18c-3.3 0-6 2.7-6 6s2.7 6 6 6s6-2.7 6-6s-2.7-6-6-6zm0 10c-2.2 0-4-1.8-4-4s1.8-4 4-4s4 1.8 4 4s-1.8 4-4 4z" fill="currentColor"></path><path d="M30 24h-2C28 13 19 4 8 4V2c12.1 0 22 9.9 22 22z" fill="currentColor"></path><path d="M22 24h-2c0-6.6-5.4-12-12-12v-2c7.7 0 14 6.3 14 14z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->订阅<!--]--></span></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/docs/message-board/" class="link" aria-label="留言板"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M17.74 30L16 29l4-7h6a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h9v2H6a4 4 0 0 1-4-4V8a4 4 0 0 1 4-4h20a4 4 0 0 1 4 4v12a4 4 0 0 1-4 4h-4.84z" fill="currentColor"></path><path d="M8 10h16v2H8z" fill="currentColor"></path><path d="M8 16h10v2H8z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->留言板<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="更多"><span class="xicon-container left title"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M25 10H7a3.003 3.003 0 0 0-3 3v6a2.002 2.002 0 0 0 2 2v7a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2V16h-2v12H8v-9H6v-6a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v6h-2v9h-4V16h-2v12a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2v-7a2.002 2.002 0 0 0 2-2v-6a3.003 3.003 0 0 0-3-3z" fill="currentColor"></path><path d="M10 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path><path d="M22 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->更多<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="更多"><span class="title"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M25 10H7a3.003 3.003 0 0 0-3 3v6a2.002 2.002 0 0 0 2 2v7a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2V16h-2v12H8v-9H6v-6a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v6h-2v9h-4V16h-2v12a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2v-7a2.002 2.002 0 0 0 2-2v-6a3.003 3.003 0 0 0-3-3z" fill="currentColor"></path><path d="M10 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path><path d="M22 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->更多<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a class="link" href="https://realDuang.github.io/leetcode-in-javascript/" target="_blank" rel="noopener noreferrer" aria-label="Leetcode In JavaScript"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Leetcode In JavaScript<!--]--></span></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/docs/about/" class="link" aria-label="关于我"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M6 21v-1H4v1a7 7 0 0 0 7 7h3v-2h-3a5 5 0 0 1-5-5z" fill="currentColor"></path><path d="M24 11v1h2v-1a7 7 0 0 0-7-7h-3v2h3a5 5 0 0 1 5 5z" fill="currentColor"></path><path d="M11 11H5a3 3 0 0 0-3 3v2h2v-2a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2h2v-2a3 3 0 0 0-3-3z" fill="currentColor"></path><path d="M8 10a4 4 0 1 0-4-4a4 4 0 0 0 4 4zm0-6a2 2 0 1 1-2 2a2 2 0 0 1 2-2z" fill="currentColor"></path><path d="M27 25h-6a3 3 0 0 0-3 3v2h2v-2a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2h2v-2a3 3 0 0 0-3-3z" fill="currentColor"></path><path d="M20 20a4 4 0 1 0 4-4a4 4 0 0 0-4 4zm6 0a2 2 0 1 1-2-2a2 2 0 0 1 2 2z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->关于我<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a class="link" href="https://github.com/realDuang/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->GitHub<!--]--></span></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><span class="xicon-container btn-toggle-dark-mode btn--dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></span><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></header><!----><div class="mobile-menus-container"><nav class="navbar-links mobile"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M16.612 2.214a1.01 1.01 0 0 0-1.242 0L1 13.419l1.243 1.572L4 13.621V26a2.004 2.004 0 0 0 2 2h20a2.004 2.004 0 0 0 2-2V13.63L29.757 15L31 13.428zM18 26h-4v-8h4zm2 0v-8a2.002 2.002 0 0 0-2-2h-4a2.002 2.002 0 0 0-2 2v8H6V12.062l10-7.79l10 7.8V26z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/timeline.html" class="link" aria-label="时间轴"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M23.586 13L21 10.414V6h2v3.586l2 2L23.586 13z" fill="currentColor"></path><path d="M22 18a8 8 0 1 1 8-8a8.01 8.01 0 0 1-8 8zm0-14a6 6 0 1 0 6 6a6.007 6.007 0 0 0-6-6z" fill="currentColor"></path><path d="M8.63 18l7 6H30v-2H16.37l-7-6H4V2H2v26a2.002 2.002 0 0 0 2 2h26v-2H4V18z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->时间轴<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a class="link" href="https://blog.realduang.com/feed.json" target="_blank" rel="noopener noreferrer" aria-label="订阅"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M8 18c-3.3 0-6 2.7-6 6s2.7 6 6 6s6-2.7 6-6s-2.7-6-6-6zm0 10c-2.2 0-4-1.8-4-4s1.8-4 4-4s4 1.8 4 4s-1.8 4-4 4z" fill="currentColor"></path><path d="M30 24h-2C28 13 19 4 8 4V2c12.1 0 22 9.9 22 22z" fill="currentColor"></path><path d="M22 24h-2c0-6.6-5.4-12-12-12v-2c7.7 0 14 6.3 14 14z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->订阅<!--]--></span></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/docs/message-board/" class="link" aria-label="留言板"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M17.74 30L16 29l4-7h6a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h9v2H6a4 4 0 0 1-4-4V8a4 4 0 0 1 4-4h20a4 4 0 0 1 4 4v12a4 4 0 0 1-4 4h-4.84z" fill="currentColor"></path><path d="M8 10h16v2H8z" fill="currentColor"></path><path d="M8 16h10v2H8z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->留言板<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="更多"><span class="xicon-container left title"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M25 10H7a3.003 3.003 0 0 0-3 3v6a2.002 2.002 0 0 0 2 2v7a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2V16h-2v12H8v-9H6v-6a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v6h-2v9h-4V16h-2v12a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2v-7a2.002 2.002 0 0 0 2-2v-6a3.003 3.003 0 0 0-3-3z" fill="currentColor"></path><path d="M10 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path><path d="M22 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->更多<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="更多"><span class="title"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M25 10H7a3.003 3.003 0 0 0-3 3v6a2.002 2.002 0 0 0 2 2v7a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2V16h-2v12H8v-9H6v-6a1 1 0 0 1 1-1h18a1 1 0 0 1 1 1v6h-2v9h-4V16h-2v12a2.002 2.002 0 0 0 2 2h4a2.002 2.002 0 0 0 2-2v-7a2.002 2.002 0 0 0 2-2v-6a3.003 3.003 0 0 0-3-3z" fill="currentColor"></path><path d="M10 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path><path d="M22 9a4 4 0 1 1 4-4a4.004 4.004 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2.002 2.002 0 0 0-2-2z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->更多<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a class="link" href="https://realDuang.github.io/leetcode-in-javascript/" target="_blank" rel="noopener noreferrer" aria-label="Leetcode In JavaScript"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Leetcode In JavaScript<!--]--></span></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/docs/about/" class="link" aria-label="关于我"><!--[--><!--]--><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M6 21v-1H4v1a7 7 0 0 0 7 7h3v-2h-3a5 5 0 0 1-5-5z" fill="currentColor"></path><path d="M24 11v1h2v-1a7 7 0 0 0-7-7h-3v2h3a5 5 0 0 1 5 5z" fill="currentColor"></path><path d="M11 11H5a3 3 0 0 0-3 3v2h2v-2a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2h2v-2a3 3 0 0 0-3-3z" fill="currentColor"></path><path d="M8 10a4 4 0 1 0-4-4a4 4 0 0 0 4 4zm0-6a2 2 0 1 1-2 2a2 2 0 0 1 2-2z" fill="currentColor"></path><path d="M27 25h-6a3 3 0 0 0-3 3v2h2v-2a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2h2v-2a3 3 0 0 0-3-3z" fill="currentColor"></path><path d="M20 20a4 4 0 1 0 4-4a4 4 0 0 0-4 4zm6 0a2 2 0 1 1-2-2a2 2 0 0 1 2 2z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->关于我<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a class="link" href="https://github.com/realDuang/blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->GitHub<!--]--></span></span><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><div class="appearance"><span>Appearance</span><span class="xicon-container btn-toggle-dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></span></div></div><div class="series-mask"></div><aside class="series-container"><div class="site-brand"><img class="logo" src="/avatar.jpg" alt="枫之谷"><a href="/" class="site-name can-hide">枫之谷</a></div><!--[--><!--]--></aside><!--[--><main class="page-container"><h1 class="page-title">NodeJS 服务 Docker 镜像极致优化指北</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Duang<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->2021-07-25 18:26:27<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[--><!--[--><a href="/categories/qianduanjishuyanjiuyuan/1.html" class="">前端技术研究院</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[--><!--[--><a href="/tags/yunyuansheng/1.html" class="">云原生</a><a href="/tags/Docker/1.html" class="">Docker</a><a href="/tags/NodeJS/1.html" class="">NodeJS</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 12 12"><g fill="none"><path d="M1.974 6.659a.5.5 0 0 1-.948-.317c-.01.03 0-.001 0-.001a1.633 1.633 0 0 1 .062-.162c.04-.095.099-.226.18-.381c.165-.31.422-.723.801-1.136C2.834 3.827 4.087 3 6 3c1.913 0 3.166.827 3.931 1.662a5.479 5.479 0 0 1 .98 1.517l.046.113c.003.008.013.06.023.11L11 6.5s.084.333-.342.474a.5.5 0 0 1-.632-.314v-.003l-.006-.016a3.678 3.678 0 0 0-.172-.376a4.477 4.477 0 0 0-.654-.927C8.584 4.673 7.587 4 6 4s-2.584.673-3.194 1.338a4.477 4.477 0 0 0-.795 1.225a2.209 2.209 0 0 0-.03.078l-.007.018zM6 5a2 2 0 1 0 0 4a2 2 0 0 0 0-4zM5 7a1 1 0 1 1 2 0a1 1 0 0 1-2 0z" fill="currentColor"></path></g></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[--><!----><span class="waline-pageview-count" data-path="/blogs/frontend-tech-institute/2021-07-25.html"></span><!--]--></span></span></div><div class="theme-reco-default-content"><div><div class="custom-container tip"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">TIP</p><p>这段时间在开发一个腾讯文档全品类通用的 HTML 动态服务，为了方便各品类接入的生成与部署，也顺应上云的趋势，考虑使用 Docker 的方式来固定服务内容，统一进行制品版本的管理。本篇文章就将我在服务 Docker 化的过程中积累起来的优化经验分享出来，供大家参考。</p></div><p>以一个例子开头，大部分刚接触 Docker 的同学应该都会这样编写项目的 Dockerfile，如下所示：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> node:14</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token comment"># 安装 npm 依赖</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm install</span>

<span class="token comment"># 暴露端口</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 8000</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;npm&quot;</span>, <span class="token string">&quot;start&quot;</span>]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>构建，打包，上传，一气呵成。然后看下镜像状态，卧槽，一个简单的 node web 服务体积居然达到了惊人的 1.3 个 G，并且镜像传输与构建速度也很慢：</p><p><img src="https://zakum-1252497671.cos.ap-guangzhou.myqcloud.com/20210709165348.png" alt="docker 镜像优化前"></p><p>要是这个镜像只需要部署一个实例也就算了，但是这个服务得提供给所有开发同学进行高频集成并部署环境的(实现高频集成的方案可参见我的 <a class="route-link" href="/blogs/frontend-tech-institute/2021-05-11.html">上一篇文章</a>)。首先，镜像体积过大必然会对镜像的拉取和更新速度造成影响，集成体验会变差。其次，项目上线后，同时在线的测试环境实例可能成千上万，这样的容器内存占用成本对于任何一个项目都是无法接受的。必须找到优化的办法解决。</p><p>发现问题后，我就开始研究 Docker 的优化方案，准备给我的镜像动手术了。</p><h2 id="node-项目生产环境优化" tabindex="-1"><a class="header-anchor" href="#node-项目生产环境优化"><span>node 项目生产环境优化</span></a></h2><p>首先开刀的是当然是前端最为熟悉的领域，对代码本身体积进行优化。之前开发项目时使用了 Typescript，为了图省事，项目直接使用 tsc 打包生成 es5 后就直接运行起来了。这里的体积问题主要有两个，一个是开发环境 ts 源码并未处理，并且用于生产环境的 js 代码也未经压缩。</p><p><img src="https://zakum-1252497671.cos.ap-guangzhou.myqcloud.com/20210709170819.png" alt="tsc 打包"></p><p>另一个是引用的 node_modules 过于臃肿。仍然包含了许多开发调试环境中的 npm 包，如 ts-node，typescript 等等。既然打包成 js 了，这些依赖自然就该去除。</p><p>一般来说，由于服务端代码不会像前端代码一样暴露出去，运行在物理机上的服务更多考虑的是稳定性，也不在乎多一些体积，因此这些地方一般也不会做处理。但是 Docker 化后，由于部署规模变大，这些问题就非常明显了，在生产环境下需要优化的。</p><p>对于这两点的优化的方式其实我们前端非常熟悉了，不是本文的重点就粗略带过了。对于第一点，使用 Webpack + babel 降级并压缩 Typescript 源码，如果担心错误排查可以加上 sourcemap，不过对于 docker 镜像来说有点多余，一会儿会说到。对于第二点，梳理 npm 包的 dependencies 与 devDependencies 依赖，去除不是必要存在于运行时的依赖，方便生产环境使用 <code>npm install --production</code> 安装依赖。</p><h2 id="优化项目镜像体积" tabindex="-1"><a class="header-anchor" href="#优化项目镜像体积"><span>优化项目镜像体积</span></a></h2><h3 id="使用尽量精简的基础镜像" tabindex="-1"><a class="header-anchor" href="#使用尽量精简的基础镜像"><span>使用尽量精简的基础镜像</span></a></h3><p>我们知道，容器技术提供的是操作系统级别的进程隔离，Docker 容器本身是一个运行在独立操作系统下的进程，也就是说，Docker 镜像需要打包的是一个能够独立运行的操作系统级环境。因此，决定镜像体积的一个重要因素就显而易见了：打包进镜像的 Linux 操作系统的体积。</p><p>一般来说，减小依赖的操作系统的大小主要需要考虑从两个方面下手，第一个是尽可能去除 Linux 下不需要的各类工具库，如 python，cmake, telnet 等。第二个是选取更轻量级的 Linux 发行版系统。正规的官方镜像应该会依据上述两个因素对每个发行版提供阉割版本。</p><p>以 node 官方提供的版本 node:14 为例，默认版本中，它的运行基础环境是 Ubuntu，是一个大而全的 Linux 发行版，以保证最大的兼容性。去除了无用工具库的依赖版本称为 node:14-slim 版本。而最小的镜像发行版称为 node:14-alpine。Linux alpine 是一个高度精简，仅包含基本工具的轻量级 Linux 发行版，本身的 Docker 镜像只有 4～5M 大小，因此非常适合制作最小版本的 Docker 镜像。</p><p>在我们的服务中，由于运行该服务的依赖是确定的，因此为了尽可能的缩减基础镜像的体积，我们选择 alpine 版本作为生产环境的基础镜像。</p><h3 id="分级构建" tabindex="-1"><a class="header-anchor" href="#分级构建"><span>分级构建</span></a></h3><p>这时候，我们遇到了新的问题。由于 alpine 的基本工具库过于简陋，而像 webpack 这样的打包工具背后可能使用的插件库极多，构建项目时对环境的依赖较大。并且这些工具库只有编译时需要用到，在运行时是可以去除的。对于这种情况，我们可以利用 Docker 的<code>分级构建</code>的特性来解决这一问题。</p><p>首先，我们可以在完整版镜像下进行依赖安装，并给该任务设立一个别名(此处为<code>build</code>)。</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token comment"># 安装完整依赖并构建产物</span>
<span class="token instruction"><span class="token keyword">FROM</span> node:14 <span class="token keyword">AS</span> build</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token instruction"><span class="token keyword">COPY</span> package*.json /app/</span>
<span class="token instruction"><span class="token keyword">RUN</span> [<span class="token string">&quot;npm&quot;</span>, <span class="token string">&quot;install&quot;</span>]</span>
<span class="token instruction"><span class="token keyword">COPY</span> . /app/</span>

<span class="token instruction"><span class="token keyword">RUN</span> npm run build</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后我们可以启用另一个镜像任务来运行生产环境，生产的基础镜像就可以换成 alpine 版本了。其中编译完成后的源码可以通过<code>--from</code>参数获取到处于<code>build</code>任务中的文件，移动到此任务内。</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> node:14-alpine <span class="token keyword">AS</span> release</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /release</span>

<span class="token instruction"><span class="token keyword">COPY</span> package*.json /</span>
<span class="token instruction"><span class="token keyword">RUN</span> [<span class="token string">&quot;npm&quot;</span>, <span class="token string">&quot;install&quot;</span>, <span class="token string">&quot;--registry=http://r.tnpm.oa.com&quot;</span>, <span class="token string">&quot;--production&quot;</span>]</span>

<span class="token comment"># 移入依赖与源码</span>
<span class="token instruction"><span class="token keyword">COPY</span> public /release/public</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /app/dist /release/dist</span>

<span class="token comment"># 启动服务</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 8000</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;node&quot;</span>, <span class="token string">&quot;./dist/index.js&quot;</span>]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Docker 镜像的生成规则是，生成镜像的结果仅以最后一个镜像任务为准。因此前面的任务并不会占用最终镜像的体积，从而完美解决这一问题。</p><p>当然，随着项目越来越复杂，在运行时仍可能会遇到工具库报错，如果曝出问题的工具库所需依赖不多，我们可以自行补充所需的依赖，这样的镜像体积仍然能保持较小的水平。</p><p>其中最常见的问题就是对<code>node-gyp</code>与<code>node-sass</code>库的引用。由于这个库是用来将其他语言编写的模块转译为 node 模块，因此，我们需要手动增加<code>g++ make python</code>这三个依赖。</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token comment"># 安装生产环境依赖(为兼容 node-gyp 所需环境需要对 alpine 进行改造)</span>
<span class="token instruction"><span class="token keyword">FROM</span> node:14-alpine <span class="token keyword">AS</span> dependencies</span>

<span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache python make g++</span>
<span class="token instruction"><span class="token keyword">COPY</span> package*.json /</span>
<span class="token instruction"><span class="token keyword">RUN</span> [<span class="token string">&quot;npm&quot;</span>, <span class="token string">&quot;install&quot;</span>, <span class="token string">&quot;--registry=http://r.tnpm.oa.com&quot;</span>, <span class="token string">&quot;--production&quot;</span>]</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk del .gyp</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>详情可见：<a href="https://github.com/nodejs/docker-node/issues/282" target="_blank" rel="noopener noreferrer">https://github.com/nodejs/docker-node/issues/282<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h2 id="合理规划-docker-layer" tabindex="-1"><a class="header-anchor" href="#合理规划-docker-layer"><span>合理规划 Docker Layer</span></a></h2><h3 id="构建速度优化" tabindex="-1"><a class="header-anchor" href="#构建速度优化"><span>构建速度优化</span></a></h3><p>我们知道，Docker 使用 Layer 概念来创建与组织镜像，Dockerfile 的每条指令都会产生一个新的文件层，每层都包含执行命令前后的状态之间镜像的文件系统更改，文件层越多，镜像体积就越大。而 Docker 使用缓存方式实现了构建速度的提升。<strong>若 Dockerfile 中某层的语句及依赖未更改，则该层重建时可以直接复用本地缓存</strong>。</p><p>如下所示，如果 log 中出现<code>Using cache</code>字样时，说明缓存生效了，该层将不会执行运算，直接拿原缓存作为该层的输出结果。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>Step <span class="token number">2</span>/3 <span class="token builtin class-name">:</span> <span class="token function">npm</span> <span class="token function">install</span>
 ---<span class="token operator">&gt;</span> Using cache
 ---<span class="token operator">&gt;</span> efvbf79sd1eb
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过研究 Docker 缓存算法，发现在 Docker 构建过程中，<strong>如果某层无法应用缓存，则依赖此步的后续层都不能从缓存加载</strong>。例如下面这个例子：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm install</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>此时如果我们更改了仓库的任意一个文件，此时因为<code>npm install</code>层的上层依赖变更了，哪怕依赖没有进行任何变动，缓存也不会被复用。</p><p>因此，若想尽可能的利用上<code>npm install</code>层缓存，我们可以把 Dockerfile 改成这样：</p><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">COPY</span> package*.json .</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm install</span>
<span class="token instruction"><span class="token keyword">COPY</span> src .</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样在仅变更源码时，<code>node_modules</code>的依赖缓存仍然能被利用上了。</p><p>由此，我们得到了优化原则：</p><ol><li><p>最小化处理变更文件，仅变更下一步所需的文件，以尽可能减少构建过程中的缓存失效。</p></li><li><p>对于处理文件变更的 ADD 命令、COPY 命令，尽量延迟执行。</p></li></ol><h3 id="构建体积优化" tabindex="-1"><a class="header-anchor" href="#构建体积优化"><span>构建体积优化</span></a></h3><p>在保证速度的前提下，体积优化也是我们需要去考虑的。这里我们需要考虑的有三点：</p><ol><li><p>Docker 是以层为单位上传镜像仓库的，这样也能最大化的利用缓存的能力。因此，<strong>执行结果很少变化的命令需要抽出来单独成层</strong>，如上面提到的<code>npm install</code>的例子里，也用到了这方面的思想。</p></li><li><p>如果镜像层数越少，总上传体积就越小。因此，<strong>在命令处于执行链尾部，即不会对其他层缓存产生影响的情况下，尽量合并命令</strong>，从而减少缓存体积。例如，设置环境变量和清理无用文件的指令，它们的输出都是不会被使用的，因此可以将这些命令合并为一行 RUN 命令。</p></li></ol><div class="language-docker line-numbers-mode" data-ext="docker" data-title="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">RUN</span> set ENV=prod &amp;&amp; rm -rf ./trash</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ol start="3"><li>Docker cache 的下载也是通过层缓存的方式，因此为了减少镜像的传输下载时间，我们最好使用<strong>固定的物理机器</strong>来进行构建。例如在流水线中指定专用宿主机，能是的镜像的准备时间大大减少。</li></ol><p>当然，时间和空间的优化从来就没有两全其美的办法，这一点需要我们在设计 Dockerfile 时，对 Docker Layer 层数做出权衡。例如为了时间优化，需要我们拆分文件的复制等操作，而这一点会导致层数增多，略微增加空间。</p><p>这里我的建议是，优先保证构建时间，其次在不影响时间的情况下，尽可能的缩小构建缓存体积。</p><h2 id="以-docker-的思维管理服务" tabindex="-1"><a class="header-anchor" href="#以-docker-的思维管理服务"><span>以 Docker 的思维管理服务</span></a></h2><h3 id="避免使用进程守护" tabindex="-1"><a class="header-anchor" href="#避免使用进程守护"><span>避免使用进程守护</span></a></h3><p>我们编写传统的后台服务时，总是会使用例如 pm2、forever 等等进程守护程序，以保证服务在意外崩溃时能被监测到并自动重启。但这一点在 Docker 下非但没有益处，还带来了额外的不稳定因素。</p><p>首先，Docker 本身就是一个流程管理器，因此，进程守护程序提供的崩溃重启，日志记录等等工作 Docker 本身或是基于 Docker 的编排程序(如 kubernetes)就能提供了，无需使用额外应用实现。除此之外，由于守护进程的特性，将不可避免的对于以下的情况产生影响：</p><ol><li><p>增加进程守护程序会使得占用的内存增多，镜像体积也会相应增大。</p></li><li><p>由于守护进程一直能正常运行，服务发生故障时，Docker 自身的重启策略将不会生效，Docker 日志里将不会记录崩溃信息，排障溯源困难。</p></li><li><p>由于多了个进程的加入，Docker 提供的 CPU、内存等监控指标将变得不准确。</p></li></ol><p>因此，尽管 pm2 这样的进程守护程序提供了能够适配 Docker 的版本：<code>pm2-runtime</code>，但我仍然不推荐大家使用进程守护程序。</p><p>其实这一点其实是源自于我们的固有思想而犯下的错误。在服务上云的过程中，难点其实不仅仅在于写法与架构上的调整，开发思路的转变才是最重要的，我们会在上云的过程中更加深刻体会到这一点。</p><h3 id="日志的持久化存储" tabindex="-1"><a class="header-anchor" href="#日志的持久化存储"><span>日志的持久化存储</span></a></h3><p>无论是为了排障还是审计的需要，后台服务总是需要日志能力。按照以往的思路，我们将日志分好类后，统一写入某个目录下的日志文件即可。但是在 Docker 中，任何本地文件都不是持久化的，会随着容器的生命周期结束而销毁。因此，我们需要将日志的存储跳出容器之外。</p><p>最简单的做法是利用 <code>Docker Manager Volume</code>，这个特性能绕过容器自身的文件系统，直接将数据写到宿主物理机器上。具体用法如下：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>app <span class="token parameter variable">-v</span> /app/log:/usr/share/log app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>运行 docker 时，通过-v 参数为容器绑定 volumes，将宿主机上的 <code>/app/log</code> 目录(如果没有会自动创建)挂载到容器的 <code>/usr/share/log</code> 中。这样服务在将日志写入该文件夹时，就能持久化存储在宿主机上，不随着 docker 的销毁而丢失了。</p><p>当然，当部署集群变多后，物理宿主机上的日志也会变得难以管理。此时就需要一个服务编排系统来统一管理了。从单纯管理日志的角度出发，我们可以进行网络上报，给到云日志服务(如腾讯云 CLS)托管。或者干脆将容器进行批量管理，例如<code>Kubernetes</code>这样的容器编排系统，这样日志作为其中的一个模块自然也能得到妥善保管了。这样的方法很多，就不多加赘述了。</p><h3 id="k8s-服务控制器的选择" tabindex="-1"><a class="header-anchor" href="#k8s-服务控制器的选择"><span>k8s 服务控制器的选择</span></a></h3><p>镜像优化之外，服务编排以及控制部署的负载形式对性能的影响也很大。这里以最流行的<code>Kubernetes</code>的两种控制器(Controller)：<code>Deployment</code> 与 <code>StatefulSet</code> 为例，简要比较一下这两类组织形式，帮助选择出最适合服务的 Controller。</p><p><code>StatefulSet</code>是 K8S 在 1.5 版本后引入的 Controller，主要特点为：能够实现 pod 间的有序部署、更新和销毁。那么我们的制品是否需要使用 <code>StatefulSet</code> 做 pod 管理呢？官方简要概括为一句话：</p><blockquote><p>Deployment 用于部署无状态服务，StatefulSet 用来部署有状态服务。</p></blockquote><p>这句话十分精确，但不易于理解。那么，什么是无状态呢？在我看来，<code>StatefulSet</code>的特点可以从如下几个步骤进行理解：</p><ol><li><p><code>StatefulSet</code>管理的多个 pod 之间进行部署，更新，删除操作时能够按照固定顺序依次进行。适用于多服务之间有依赖的情况，如先启动数据库服务再开启查询服务。</p></li><li><p>由于 pod 之间有依赖关系，因此每个 pod 提供的服务必定不同，所以 <code>StatefulSet</code> 管理的 pod 之间没有负载均衡的能力。</p></li><li><p>又因为 pod 提供的服务不同，所以每个 pod 都会有自己独立的存储空间，pod 间不共享。</p></li><li><p>为了保证 pod 部署更新时顺序，必须固定 pod 的名称，因此不像 <code>Deployment</code> 那样生成的 pod 名称后会带一串随机数。</p></li><li><p>而由于 pod 名称固定，因此跟 <code>StatefulSet</code> 对接的 <code>Service</code> 中可以直接以 pod 名称作为访问域名，而不需要提供<code>Cluster IP</code>，因此跟 <code>StatefulSet</code> 对接的 <code>Service</code> 被称为 <code>Headless Service</code>。</p></li></ol><p>通过这里我们就应该明白，如果在 k8s 上部署的是单个服务，或是多服务间没有依赖关系，那么 <code>Deployment</code> 一定是简单而又效果最佳的选择，自动调度，自动负载均衡。而如果服务的启停必须满足一定顺序，或者每一个 pod 所挂载的数据 volume 需要在销毁后依然存在，那么建议选择 <code>StatefulSet</code>。</p><p>本着如无必要，勿增实体的原则，强烈建议所有运行单个服务工作负载采用 <code>Deployment</code> 作为 Controller。</p><h2 id="写在结尾" tabindex="-1"><a class="header-anchor" href="#写在结尾"><span>写在结尾</span></a></h2><p>一通研究下来，差点把一开始的目标忘了，赶紧将 Docker 重新构建一遍，看看优化成果。</p><p><img src="https://zakum-1252497671.cos.ap-guangzhou.myqcloud.com/20210727180211.png" alt="docker 镜像优化后"></p><p>可以看到，对于镜像体积的优化效果还是不错的，达到了 10 倍左右。当然，如果项目中不需要如此高版本的 node 支持，还能进一步缩小大约一半的镜像体积。</p><p>之后镜像仓库会对存放的镜像文件做一次压缩，以 node14 打包的镜像版本最终被压缩到了 50M 以内。</p><p><img src="https://zakum-1252497671.cos.ap-guangzhou.myqcloud.com/20210727180435.png" alt="镜像仓库优化前后"></p><p>当然，除了看得到的体积数据之外，更重要的优化其实在于，从面向物理机的服务向容器化云服务在架构设计层面上的转变。</p><p>容器化已经是看得见的未来，作为一名开发人员，要时刻保持对前沿技术的敏感，积极实践，才能将技术转化为生产力，为项目的进化做出贡献。</p><p>参考资料：</p><ol><li>《Kubernetes in action》--Marko Lukša</li><li><a href="https://linuxhint.com/optimizing-docker-images/" target="_blank" rel="noopener noreferrer">Optimizing Docker Images<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ol></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Last Updated 1/23/2025, 7:38:16 AM<!--]--></span></span></div></footer><!----><div class="reco-waline-wrapper"><div data-waline hidecomments="false" pageview="false"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">NickName</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">E-Mail</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">Website</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="Comment here..."></textarea><div class="wl-preview" style="display:none;"><hr><h4>Preview:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="Emoji" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="GIF"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="Upload Image"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="Preview"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if-->  Words</div><button type="button" class="wl-btn">Login</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->Submit<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="Search GIF"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> Comments</div><ul class="wl-sort"><!--[--><li class="active">Latest</li><li class="">Oldest</li><li class="">Hottest</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><!--[--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><!--]--><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v2.15.8</div></div></div></main><!--]--><div class="page-catalog-container"><h5 class="tip">导航条</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#node-项目生产环境优化" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="node 项目生产环境优化"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->node 项目生产环境优化<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#优化项目镜像体积" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="优化项目镜像体积"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->优化项目镜像体积<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#使用尽量精简的基础镜像" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="使用尽量精简的基础镜像"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->使用尽量精简的基础镜像<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#分级构建" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="分级构建"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->分级构建<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#合理规划-docker-layer" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="合理规划 Docker Layer"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->合理规划 Docker Layer<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#构建速度优化" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="构建速度优化"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->构建速度优化<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#构建体积优化" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="构建体积优化"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->构建体积优化<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#以-docker-的思维管理服务" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="以 Docker 的思维管理服务"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->以 Docker 的思维管理服务<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#避免使用进程守护" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="避免使用进程守护"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->避免使用进程守护<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#日志的持久化存储" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="日志的持久化存储"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->日志的持久化存储<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#k8s-服务控制器的选择" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="k8s 服务控制器的选择"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->k8s 服务控制器的选择<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/frontend-tech-institute/2021-07-25.html#写在结尾" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="写在结尾"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->写在结尾<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DG1e-Jaf.js" defer></script>
  </body>
</html>
